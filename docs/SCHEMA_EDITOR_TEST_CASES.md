# Schema 可视化编辑器 - 测试用例设计文档

**版本**: v1.0  
**日期**: 2026-02-10  
**对应功能**: Schema Editor (Issue #3)

---

## 1. 测试策略

### 1.1 测试范围
| 模块 | 优先级 | 测试类型 |
|------|--------|----------|
| 页面加载和初始化 | P0 | 冒烟测试 |
| 实体类型 CRUD | P0 | 功能测试 |
| 关系类型 CRUD | P0 | 功能测试 |
| 属性配置 | P0 | 功能测试 |
| 撤销/重做 | P1 | 功能测试 |
| 保存/加载 | P0 | 集成测试 |
| 画布交互 | P1 | 交互测试 |
| 边界条件 | P2 | 异常测试 |

### 1.2 测试环境
- **浏览器**: Chromium (Playwright)
- **分辨率**: 1920x1080
- **前置条件**: 后端服务运行，至少有一个示例图谱

---

## 2. 测试用例详情

### TC-SE-01: 页面加载和初始化

**目标**: 验证 Schema 编辑器页面正确加载

**前置条件**: 
- 前后端服务正常运行
- 访问路径: `/schema-editor`

**测试步骤**:
1. 访问 `http://localhost:8080/schema-editor`
2. 等待页面加载完成
3. 验证页面元素

**预期结果**:
| 检查点 | 期望值 |
|--------|--------|
| 页面标题 | 显示 "Schema 可视化编辑器" |
| 工具栏按钮 | 至少 5 个按钮可见 |
| 左侧工具面板 | 可见，包含选择/实体/关系按钮 |
| 画布区域 | React Flow 画布可见 |
| 背景网格 | 点状背景可见 |
| Controls | 缩放控制按钮可见 |
| MiniMap | 缩略图可见 |
| 属性面板 | 右侧属性面板可见，显示空状态 |

**截图点**: 页面初始化完成后

---

### TC-SE-02: 创建实体类型

**目标**: 验证可以通过拖拽创建实体类型

**前置条件**: 页面已加载

**测试步骤**:
1. 点击左侧工具栏的 "➕ 实体" 按钮
2. 验证按钮变为选中状态（primary 样式）
3. 验证显示模式提示 "点击画布空白处创建实体类型"
4. 在画布中间位置点击
5. 验证实体节点创建成功
6. 在属性面板填写:
   - 类型名称: "测试实体类型"
   - 描述: "这是用于自动化测试的实体类型"
7. 点击保存按钮

**预期结果**:
| 检查点 | 期望值 |
|--------|--------|
| 实体节点 | 在点击位置创建节点 |
| 节点显示 | 显示默认名称 "新实体类型" |
| 属性面板 | 自动打开，显示实体类型编辑表单 |
| 保存成功 | 显示消息 "保存成功" |
| 节点更新 | 节点显示更新后的名称 |

**数据变化**:
- Schema.entityTypes 新增一个实体类型
- 节点位置信息正确记录

---

### TC-SE-03: 编辑实体类型

**目标**: 验证可以编辑已有实体类型

**前置条件**: 已创建测试实体

**测试步骤**:
1. 点击已创建的实体节点
2. 验证属性面板切换为实体编辑模式
3. 修改类型名称为 "修改后的实体名称"
4. 点击颜色选择器，选择新颜色
5. 点击保存按钮

**预期结果**:
| 检查点 | 期望值 |
|--------|--------|
| 节点选中 | 节点边框高亮显示（红色） |
| 表单回填 | 属性面板显示当前实体数据 |
| 名称更新 | 节点标签更新为新名称 |
| 颜色更新 | 节点边框颜色更新 |

---

### TC-SE-04: 删除实体类型

**目标**: 验证可以删除实体类型

**前置条件**: 已创建测试实体

**测试步骤**:
1. 点击已创建的实体节点选中
2. 点击属性面板的 "删除" 按钮
3. 在确认弹窗点击 "删除" 确认

**预期结果**:
| 检查点 | 期望值 |
|--------|--------|
| 确认弹窗 | 显示确认信息 |
| 删除成功 | 显示消息 "删除成功" |
| 节点消失 | 实体节点从画布移除 |
| 属性面板 | 恢复为空状态 |

**边界条件**:
- 有关联关系的实体删除时的处理
- 删除后撤销可恢复

---

### TC-SE-05: 添加实体属性

**目标**: 验证可以为实体类型添加属性

**前置条件**: 已创建测试实体

**测试步骤**:
1. 选中实体节点
2. 在属性配置区域填写:
   - 属性名: `testProperty`
   - 属性标签: `测试属性`
   - 属性类型: `String`
3. 点击 "添加属性" 按钮
4. 验证属性列表显示新属性

**预期结果**:
| 检查点 | 期望值 |
|--------|--------|
| 属性表单 | 显示属性名、标签、类型选择 |
| 添加成功 | 属性列表展开显示新属性 |
| 属性标签 | 显示属性名和类型标签 |
| 节点显示 | 显示属性数量 "1 属性" |

**属性类型测试矩阵**:
| 类型 | 预期行为 |
|------|----------|
| String | 显示字符串类型标签 |
| Integer | 显示整数类型标签，可配置 min/max |
| Boolean | 显示布尔类型标签 |
| Date | 显示日期类型标签 |
| Enum | 显示枚举类型标签，可配置选项 |
| ObjectProperty | 显示对象属性标签 |

---

### TC-SE-06: 创建关系类型

**目标**: 验证可以通过拖拽创建关系类型

**前置条件**: 已创建至少两个实体

**测试步骤**:
1. 点击 "➡️ 关系" 按钮
2. 验证显示模式提示
3. 从源实体拖拽连线到目标实体
4. 验证关系边创建
5. 在属性面板填写关系名称和描述
6. 点击保存

**预期结果**:
| 检查点 | 期望值 |
|--------|--------|
| 边创建 | 显示带箭头的连线 |
| 边标签 | 显示默认名称 "新关系" |
| 属性面板 | 切换为关系类型编辑模式 |
| 保存后 | 边标签更新为新名称 |

**技术细节**:
- 使用 `getBezierPath` 计算曲线路径
- 边支持双向/单向配置

---

### TC-SE-07: 撤销和重做

**目标**: 验证撤销/重做功能正常工作

**前置条件**: 页面已加载

**测试步骤**:
1. 创建一个实体
2. 点击撤销按钮
3. 验证实体消失
4. 点击重做按钮
5. 验证实体恢复

**预期结果**:
| 操作 | 预期结果 |
|------|----------|
| 撤销 | 上一步操作被撤销 |
| 重做 | 被撤销的操作恢复 |
| 按钮状态 | 无历史时按钮禁用 |

**快捷键测试**:
- Ctrl+Z: 撤销
- Ctrl+Y: 重做

---

### TC-SE-08: 保存 Schema

**目标**: 验证可以保存 Schema 到后端

**前置条件**: 已创建/修改内容

**测试步骤**:
1. 创建实体并修改属性
2. 点击顶部 "保存" 按钮
3. 等待保存完成

**预期结果**:
| 检查点 | 期望值 |
|--------|--------|
| 保存按钮 | 有变更时可用，保存后禁用 |
| 成功提示 | 显示 "Schema 保存成功" |
| 网络请求 | POST /api/v1/schema/save |
| 数据完整性 | 保存的 Schema 包含所有变更 |

**API 验证**:
```javascript
POST /api/v1/schema/save
{
  graphId: "xxx",
  schema: {
    entityTypes: {...},
    relationTypes: {...}
  }
}
```

---

### TC-SE-09: 画布交互

**目标**: 验证画布的平移、缩放功能

**前置条件**: 画布上有实体节点

**测试步骤**:
1. 拖拽画布空白处平移视图
2. 点击放大按钮两次
3. 点击缩小按钮一次
4. 点击适应视图按钮

**预期结果**:
| 操作 | 预期结果 |
|------|----------|
| 平移 | 画布内容跟随移动 |
| 放大 | 内容放大显示 |
| 缩小 | 内容缩小显示 |
| 适应视图 | 所有节点可见并居中 |

**缩放级别**:
- Min Zoom: 0.1
- Max Zoom: 3

---

### TC-SE-10: 空状态验证

**目标**: 验证未选中时的属性面板状态

**前置条件**: 页面已加载，未选中任何节点

**测试步骤**:
1. 访问编辑器页面
2. 不点击任何节点
3. 查看右侧属性面板

**预期结果**:
| 检查点 | 期望值 |
|--------|--------|
| 空状态图标 | Ant Design Empty 组件 |
| 提示文字 | "选择一个实体类型或关系类型进行编辑" |
| 编辑表单 | 不显示 |

---

### TC-SE-11: 关联图谱 Schema 编辑

**目标**: 验证可以编辑特定图谱的 Schema

**前置条件**: 存在至少一个图谱

**测试步骤**:
1. 通过 API 获取图谱列表
2. 访问 `/schema-editor/{graphId}`
3. 验证 Schema 数据加载

**预期结果**:
| 检查点 | 期望值 |
|--------|--------|
| 页面加载 | Schema Editor 正常加载 |
| 数据加载 | 加载该图谱关联的 Schema |
| 现有节点 | 如有 Schema，显示现有节点 |

---

## 3. 边界条件和异常测试

### 3.1 边界条件

| 场景 | 测试步骤 | 预期结果 |
|------|----------|----------|
| 创建大量实体 | 连续创建 50+ 个实体 | 性能可接受，无卡顿 |
| 长名称实体 | 输入 100 字符名称 | 正确截断显示 |
| 特殊字符 | 名称包含特殊字符 | 正确处理或提示错误 |
| 空名称 | 名称为空时保存 | 显示验证错误 |
| 同名属性 | 添加重复属性名 | 提示属性已存在 |

### 3.2 异常测试

| 场景 | 测试步骤 | 预期结果 |
|------|----------|----------|
| 后端保存失败 | 模拟 500 错误 | 显示错误提示 |
| 网络中断 | 断开网络后保存 | 显示网络错误 |
| Schema 加载失败 | 访问无效 graphId | 显示错误页面 |

---

## 4. 测试数据

### 4.1 测试实体类型
```javascript
const TEST_ENTITY = {
  name: '测试实体类型',
  description: '这是用于自动化测试的实体类型',
  color: '#52c41a',
  properties: {
    testProperty: {
      type: 'String',
      label: '测试属性',
      required: true
    }
  }
};
```

### 4.2 测试关系类型
```javascript
const TEST_RELATION = {
  name: '测试关系',
  description: '这是用于自动化测试的关系类型',
  from: ['Entity1'],
  to: ['Entity2'],
  bidirectional: false
};
```

---

## 5. 自动化测试执行

### 5.1 运行单个测试
```bash
npx playwright test e2e/schema-editor.spec.js --reporter=list
```

### 5.2 运行特定用例
```bash
npx playwright test e2e/schema-editor.spec.js -g "TC-SE-02"
```

### 5.3 带调试模式
```bash
npx playwright test e2e/schema-editor.spec.js --debug
```

### 5.4 生成报告
```bash
npx playwright test e2e/schema-editor.spec.js --reporter=html
npx playwright show-report
```

---

## 6. 测试覆盖率目标

| 模块 | 目标覆盖率 | 当前状态 |
|------|-----------|----------|
| 实体类型 CRUD | 100% | 🚧 待执行 |
| 关系类型 CRUD | 100% | 🚧 待执行 |
| 属性配置 | 100% | 🚧 待执行 |
| 撤销/重做 | 100% | 🚧 待执行 |
| 保存/加载 | 100% | 🚧 待执行 |
| 画布交互 | 80% | 🚧 待执行 |
| 异常处理 | 60% | 🚧 待执行 |

---

**文档更新**: 2026-02-10  
**下次评审**: 功能完成合并后
